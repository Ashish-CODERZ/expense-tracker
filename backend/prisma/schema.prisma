generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  googleId     String?   @unique @map("google_id") @db.VarChar(255)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamp(3)
  expenses     Expense[]
  otpCodes     OtpCode[]

  @@map("users")
}

model OtpCode {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  intent    String    @db.VarChar(16)
  codeHash  String    @map("code_hash") @db.VarChar(128)
  attempts  Int       @default(0)
  expiresAt DateTime  @map("expires_at") @db.Timestamp(3)
  consumedAt DateTime? @map("consumed_at") @db.Timestamp(3)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamp(3)

  @@index([userId, intent, expiresAt], map: "otp_codes_user_intent_expires_idx")
  @@map("otp_codes")
}

model Expense {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount         Decimal  @db.Decimal(12, 2)
  category       String
  description    String?
  date           DateTime @db.Date
  idempotencyKey String   @map("idempotency_key")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(3)

  @@unique([userId, idempotencyKey], map: "expenses_user_id_idempotency_key_key")
  @@index([userId, date], map: "expenses_user_date_idx")
  @@index([userId, category, date], map: "expenses_user_category_date_idx")
  @@map("expenses")
}
